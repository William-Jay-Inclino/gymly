generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  GYM_OWNER
  GYM_STAFF
}

model Limit {
  id         Int     @id
  name String 
  value Int

  settings GymLimit[]

  @@map("limits")
}

model GymLimit {
  id         Int     @id @default(autoincrement())
  gym_id        String
  limit_id        Int
  value Int 

  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)
  limit Limit @relation(fields: [limit_id], references: [id], onDelete: Restrict)

  @@unique([gym_id, limit_id])
  @@map("gym_limits")
}

model GymStats {
  id            String   @id @default(uuid())
  gym_id        String   @unique
  total_revenue Decimal   @db.Decimal
  total_members Int      @default(0)
  updated_at    DateTime @updatedAt @db.Timestamptz

  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@map("gym_stats")
}

model Revenue {
  id        String   @id @default(uuid())
  gym_id    String
  year      Int
  month     Int      // 1 = Jan, 12 = Dec
  amount    Float    // Store as number for easy calculations
  created_at DateTime @default(now()) @db.Timestamptz

  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@unique([gym_id, year, month])
  @@map("revenues")
}

model MembershipCount {
  id         String   @id @default(uuid())
  gym_id     String
  year       Int
  month      Int      // 1 = Jan, 12 = Dec
  count      Int      // Number of new memberships for this month
  created_at DateTime @default(now()) @db.Timestamptz

  gym Gym @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@unique([gym_id, year, month])
  @@map("membership_counts")
}

model User {
  id             String   @id @default(uuid())
  username       String?  @unique
  firstname  String
  lastname  String
  password  String
  role           Role     @default(GYM_OWNER)
  contact_number String?
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now()) @db.Timestamptz
  created_by     String

  gyms      Gym[]
  gym_staff GymStaff? @relation("UserGymStaff")

  @@index([username])
  @@map("users")
}

model Member {
  id             String   @id @default(uuid())
  firstname      String
  lastname       String
  contact_number String?
  created_at     DateTime @default(now()) @db.Timestamptz
  created_by     String

  memberships     Membership[]
  attendance_logs MemberTimeLogs[]

  @@index([firstname, lastname])
  @@map("members")
}


model Gym {
  id         String   @id @default(uuid())
  owner_id String
  name       String
  location   String
  created_at DateTime @default(now()) @db.Timestamptz
  created_by String

  memberships      Membership[]
  member_time_logs MemberTimeLogs[]

  gym_stats        GymStats?

  revenues         Revenue[]         
  staffs         GymStaff[]         
  limits         GymLimit[]         
  membership_counts MembershipCount[]  
  owner   User    @relation(fields: [owner_id], references: [id], onDelete: Restrict)


  @@map("gyms")
}

model GymStaff {
  id         Int     @id @default(autoincrement())
  user_id   String @unique
  gym_id      String
  
  created_at  DateTime  @default(now()) @db.Timestamptz
  created_by  String

  user   User    @relation("UserGymStaff", fields: [user_id], references: [id], onDelete: Cascade)
  gym      Gym       @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([gym_id])
  @@map("gym_staffs")
}

model Membership {
  id          String    @id @default(uuid())
  member_id   String
  gym_id      String
  start_date  DateTime  @default(now()) @db.Timestamptz
  end_date    DateTime? @default(now()) @db.Timestamptz
  sessions_left Int? 
  is_active   Boolean   @default(true)
  is_reminded   Boolean   @default(false)
  
  // plan details
  plan_name String
  plan_description String?
  amount_paid     Decimal   @db.Decimal

  created_at  DateTime  @default(now()) @db.Timestamptz
  created_by  String

  member   Member    @relation(fields: [member_id], references: [id], onDelete: Restrict)
  gym      Gym       @relation(fields: [gym_id], references: [id], onDelete: Restrict)

  @@index([member_id])
  @@index([gym_id])
  @@map("memberships")
}

model Plan {
  id              String   @id @default(uuid())
  gym_id      String
  name            String
  description     String?
  price           Decimal  @db.Decimal
  num_of_days     Int?
  num_of_sessions Int?
  created_at      DateTime @default(now()) @db.Timestamptz
  created_by      String

  @@index([gym_id])
  @@map("plans")
}

model MemberTimeLogs {
  id            Int      @id @default(autoincrement())
  member_id     String
  gym_id        String
  checked_in_at DateTime @default(now()) @db.Timestamptz
  recorded_by   String

  member Member @relation(fields: [member_id], references: [id], onDelete: Cascade)
  gym    Gym    @relation(fields: [gym_id], references: [id], onDelete: Cascade)

  @@index([member_id, gym_id, checked_in_at])
  @@map("member_time_logs")
}

